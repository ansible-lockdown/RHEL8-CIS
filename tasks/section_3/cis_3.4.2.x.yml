---

- name: "SCORED | 3.4.2.1 | PATCH | Ensure firewalld service is stopped and disabled at boot"
  become: true
  service:
      name: firewalld
      state: stopped
      enabled: no
  when:
      - rhel8cis_firewall == "firewalld"
      - rhel8cis_rule_3_4_2_1
  tags:
      - level1-server
      - level1-workstation
      - patch
      - rule_3_4_2_1

- name: "SCORED | 3.4.2.3 | PATCH | Ensure nftables is not enabled"
  become: true
  systemd:
      name: nftables
      enabled: false
      masked: true
  when:
      - rhel8cis_firewall == "firewalld"
      - rhel8cis_rule_3_4_2_3
  tags:
      - level1-server
      - level1-workstation
      - patch
      - rule_3_4_2_3

- name: "SCORED | 3.4.2.6 | AUDIT | Ensure unnecessary services and ports are not accepted"
  become: true
  block:
      - name: "SCORED | 3.4.2.6 | AUDIT | Ensure unnecessary services and ports are not accepted | Get list of services and ports"
        shell: "firewall-cmd --get-active-zones | awk '!/:/ {print $1}' | while read ZN; do firewall-cmd --list-all --zone=$ZN; done"
        changed_when: false
        failed_when: false
        check_mode: no
        register: rhel8cis_3_4_2_6_servicesport

      - name: "SCORED | 3.4.2.6 | AUDIT | Ensure unnecessary services and ports are not accepted | Show services adn ports"
        debug:
            msg:
                - "The items below are the services and ports that are accepted, please correct as needed"
                - "{{ rhel8cis_3_4_2_6_servicesport.stdout_lines }}"
  when:
      - rhel8cis_firewall == "firewalld"
      - rhel8cis_rule_3_4_2_6
  tags:
      - level1-server
      - level1-workstation
      - audit
      - rule_3.4.2.6
